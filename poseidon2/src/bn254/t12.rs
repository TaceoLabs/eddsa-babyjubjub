//! Poseidon2 implementation for `t=12`.
//!
//! Parameters are compatible with the original Poseidon2 parameter generation script found at:
//! [https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage](https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage)

use crate::perm::Poseidon2Permutation;
use ark_ff::MontFp;

type Scalar = ark_bn254::Fr;

const T: usize = 12;
const D: u64 = 5;
const ROUNDS_F: usize = 8;
const ROUNDS_P: usize = 57;

const MAT_DIAG_M_1: [Scalar; T] = [
    MontFp!("14804622731781512696315576582558312858161903712635910682897757905715135991802"),
    MontFp!("13948676545401675136823212162324890658477290502324631730554743853762568560562"),
    MontFp!("18573945917483589497580334056423642197266945436605123523601079880465846030150"),
    MontFp!("8729872397681777568903970788140009499846805496488749202415405262625559996707"),
    MontFp!("6733267510445503216688550395701864260369471054698100753620040125682200774393"),
    MontFp!("4647893059412328095122344162311078581589972117534835485658488721697422143973"),
    MontFp!("5870478220294807064971008420576706575078491597877429931529455667675843424470"),
    MontFp!("10512640846367398330492250062133863281361908365492292200075958680787987818570"),
    MontFp!("20320921868158526035982314624340244714969548878101204174363205620139814345940"),
    MontFp!("4102668762660989688484974137744466909186836897506517962330870963980460421435"),
    MontFp!("16755349246413946936913638721573146693430716144231560475461408084466563751252"),
    MontFp!("3939321505976049480393056585428904569429609899121334816629096895692522663479"),
];
const EXTERNAL_RC: [[Scalar; T]; ROUNDS_F] = [
    // First external
    [
        MontFp!("6903748691281949776257419107022191442020379352332263545405638070999458534964"),
        MontFp!("10135924669908147604916187463388086828118048537645781159375662285705585159489"),
        MontFp!("4762853742221138536625929082732222076807681526252056314834169136935321761346"),
        MontFp!("13851850319682481794090380097971486592554008015083086081339393859914618685453"),
        MontFp!("18640456789050919795296106792562761193910599677625579302529381799219997966769"),
        MontFp!("1063410554838747960627350524658671688220330766937254016313996765415954401419"),
        MontFp!("6981427973159110417772193423689464029463509434550952761586898888389261691257"),
        MontFp!("1206141243961298172028334685015556339858239094194740543001991605402397817841"),
        MontFp!("14091201636714906232420863110921306338984903984902051963311064922230307748297"),
        MontFp!("4621059653441896039288189694455944066629295595443668817483496292341167015433"),
        MontFp!("7066902431809933954047836488839669032695309406127631483240694643511936003281"),
        MontFp!("17315087199240419579125821681059506243545951016023030209257815341869266655888"),
    ],
    [
        MontFp!("10059103040060332638608789115145729824514562916586485297215408937857357949536"),
        MontFp!("11225068652502707000463586806672841026056519897666348878526399037474338566530"),
        MontFp!("16248429725108166451905951066671177495439393129398586446577332756547818322759"),
        MontFp!("1603792411107624940226116593332233432011069442952022698614835894070146206261"),
        MontFp!("6774539726199809202979284950480483022470165214850625819428653670557247397980"),
        MontFp!("3586926062845102406405158888155003355895541477935990729368650887370760167456"),
        MontFp!("8408341457793976386463098465736712226766702973823364631783063640008948186698"),
        MontFp!("5256478093150680188246911493033317653585552330564217145250937159456314444080"),
        MontFp!("1504409559966253879307512461602621719224048227961179557824120148903170752005"),
        MontFp!("15942277966092958789865731255620451984205876243926907227688623849872063375522"),
        MontFp!("21869547966352947375782262518008477792647238708569563731381487417254862568927"),
        MontFp!("20514116575097587292674851162002597982505255590849429125121277549486639963905"),
    ],
    [
        MontFp!("18452825194313044896957916066968404455052273963919089298429641311345538238456"),
        MontFp!("15032109929753839060426691777938151161036383914078878128828960678386524230520"),
        MontFp!("11008836257716466697607756644044649402905155732275601799316443545895005098336"),
        MontFp!("10241475851473595855988890695965197754453356230424727557987291249558808176803"),
        MontFp!("15576673699098699431515817212689720282756717710943853660965953327533738411469"),
        MontFp!("21136324635151732495922239476728073664748688949612906356897599635864558070878"),
        MontFp!("1882219330934809388553624072821195938671277594479225434222218191396628445719"),
        MontFp!("14770822824110349958021202843859136572225680052226609325629103928451089737502"),
        MontFp!("16296972138892584102475185578175164443828273241003772964462835469279950245028"),
        MontFp!("17567136210995681644199595234797603658087894698934069757197652336706392541039"),
        MontFp!("2503401982526840079396431296411837414346424475702317452367898515680284089488"),
        MontFp!("10102186421306783686631548937427195971758046666924679906147541083802284088511"),
    ],
    [
        MontFp!("11445236576189929830477112241638185216870389547619477674797475194332026520442"),
        MontFp!("18075607434819430210437456216126106291710417330510803034683220822804917563993"),
        MontFp!("3967214693152270797563693896702624079026549015259139581878105729582960575708"),
        MontFp!("5367281416248573581910499751669726959957794785209967831822732558354359375409"),
        MontFp!("11642316922823311271282274972742385981097893670378132870361894324444875202383"),
        MontFp!("15114589667320792529721429293103023563515802743178436242352109416406377234716"),
        MontFp!("6020211463218722813630863695002737242625157549259769175158108065095451852185"),
        MontFp!("12500218398386404785125844415757790149493637846488342545757544615316105786528"),
        MontFp!("20911076331149682853662124211469800962950299308358734742031818188776064090162"),
        MontFp!("19703811156174408816617185185507567955067340672368894507531705499677101086530"),
        MontFp!("17496511425945091313140646496102070388219304993485856308784034871590153576082"),
        MontFp!("4721179993779445814676819820031804931597716999614047506399561185693349935486"),
    ],
    // Second external
    [
        MontFp!("4338059109274059602050673686874533635255030777818774604029392304265494398157"),
        MontFp!("5929755603265876010818788351051118438529818873882227162318181686205775815115"),
        MontFp!("19574741757486954547662368402126036783038249168011411173645295065291409343277"),
        MontFp!("4060572660671711486796093474224549382740571139986124666975945256751010516449"),
        MontFp!("3065475535243545002355804493801389575719040056324250981027475682988088925530"),
        MontFp!("17932421953801579866664288722571434369121847507090271216907430546538164661995"),
        MontFp!("15360579721089148610231508261656271226310399046567778248853834584007472018704"),
        MontFp!("3659514070319551396528387814724364111051715180531431521399277903791652124693"),
        MontFp!("8296006255221657515628190018016452066188159223738454665387431748814421378732"),
        MontFp!("16338083942943915401375484234902515628722379969042849352740794631790551525827"),
        MontFp!("1062572334309346088435167342702364108117637145907570644214229569150295458280"),
        MontFp!("7643230955989151345323685572637398783437316897078430956898985280543972909391"),
    ],
    [
        MontFp!("20217251395280797877833055770153129048261918939231682672321983229261071949751"),
        MontFp!("19697047606350510022650537581381132576139684814873692706761521432078352058451"),
        MontFp!("14948096716131880753073041856927955074009204396350388000018085264192962575418"),
        MontFp!("19360213457064060029409821446848313907846861383672538067905942920399431879963"),
        MontFp!("5022271685961290881278755369171952357688747998358320443351216429025238549769"),
        MontFp!("5456631139384672905511549332153794473713051444620508487684758080246573194560"),
        MontFp!("17488910648463090135329649356752982793215190735532858151048204153589713121193"),
        MontFp!("11899801059910377368351436399097749686246206618122195295179091128123294550514"),
        MontFp!("8732402705986571244340496168624673039480309919947423180998335096658270310741"),
        MontFp!("8097457400409003746263658682482292465904611329797307008949429385176680321572"),
        MontFp!("11553436933935636141296193416686572798050894580315406407305434347240056296098"),
        MontFp!("17959824908672153960933783903770068041001746810611217672612596632278734285700"),
    ],
    [
        MontFp!("21161723792453621907902369055917987927327666131510678964405397505077066737256"),
        MontFp!("16523792608192399916245615541784322892690011899837397620354756633286651358547"),
        MontFp!("2678308407401082806463062991325040589873493617063405997340551933708326580717"),
        MontFp!("13047508488484109725755397704375155168196514077787313701027241766754107644493"),
        MontFp!("3761989357993917730248702794879079637069196806981104525739971514805103430217"),
        MontFp!("10408002972668247812771586615548246246249253667623187917081213975466884107507"),
        MontFp!("15422343527793306255203932149731889497249854326346105050387384492856772617216"),
        MontFp!("21205393322456346490709346501471453473926643884972596504443467743504319529346"),
        MontFp!("582786624929665458413948577805091535621460534396636136520949543457621752794"),
        MontFp!("1456052280506826266296281937904068019023147163849247026302759656681558188675"),
        MontFp!("7301047661881269467336374185113769340673166228411049389380957195632139306766"),
        MontFp!("16583766237008702949557787816582736799797698933852190699359938562530989987471"),
    ],
    [
        MontFp!("2009214567115152368903063298665416529487172213087111858866453119650227006436"),
        MontFp!("15410774420391732085780928259040108031449173023446795103029703469865859638040"),
        MontFp!("16579667184723709094257819569657979536643649569651472681871264126491813468156"),
        MontFp!("4501907674705258540119891518422112595263906819227543501026605713900093029551"),
        MontFp!("11806640411394935310003889113549219875193614611872996055878738516572450808112"),
        MontFp!("1995382563458951654050617078519507064819110620473017892655095408881323058807"),
        MontFp!("14988352610898687546708906153393496487920363152428617228473275160493337473370"),
        MontFp!("13817004915601992502821259576202632995361873855316636270703155351983818041580"),
        MontFp!("6065125963695948821139335735929141186703918916624823876490051306199737020919"),
        MontFp!("8950508582964839497929140372757490513399919950917035581822839008679940460535"),
        MontFp!("16274142896187579814598718683777455126588614619987512945276879571634376586657"),
        MontFp!("8103602522982880928802542314852125940162832417178464908231504954116128115517"),
    ],
];
const INTERNAL_RC: [Scalar; ROUNDS_P] = [
    MontFp!("21621161423990439140094771006446244608167034030613875972344666229505053544606"),
    MontFp!("18778187750426709050921820541006113407528252324413744171103577067551793534457"),
    MontFp!("16213362679445344130659546092032994232806761198156474662334286932445562409821"),
    MontFp!("16946682503455207390562826793778676838491810444709754284343490738493308916095"),
    MontFp!("11770600147774677933081996620877865899146097550444536705112841058263738283320"),
    MontFp!("9719813765898000409066966240574304443653756451222508421945658873353567656560"),
    MontFp!("16138039303338246587216310065162846896404195044296575762058245899533193541320"),
    MontFp!("18388533630831489550136678846157141544632470901286778836899046881641833606712"),
    MontFp!("18814754535906075828760319370716309947518903358955607204404557570520730409382"),
    MontFp!("13293921422784760733543873709103401211916581034100856336733548209248784001813"),
    MontFp!("5749009687717148403566049407691375176634305624901236640467080668006554587835"),
    MontFp!("2557416798033120267582159153387501439729103704481631715514508261446530770871"),
    MontFp!("15460237810258106974485632444188476346842755526264490556610797846450024139752"),
    MontFp!("638262665311855091997937673184799685290703727396196145158532326744460599952"),
    MontFp!("20734223203174738797466592178639936682092262500204577613923058297951955260353"),
    MontFp!("8838622538970341351914812748452473463940654878529957113614973499027324042329"),
    MontFp!("17761362674290976308584014295705395159489115260982733811503039527206708141830"),
    MontFp!("3698646027326684975899455032538574969774356833606264583729817247789492443031"),
    MontFp!("6489355587110900738040476609056317712209099745972152587980542876979718954196"),
    MontFp!("11714343297993729218138559250513087756461984105914082014842440976920407407448"),
    MontFp!("3024894741735997469874474064694238659854425390836341173636075486701312586909"),
    MontFp!("12970579058570311745372671741019874966948643604080182653000093400244133654736"),
    MontFp!("97594509226436573664181575221224206967460863898476070720155741752378375303"),
    MontFp!("5139582270350374713068485115813284471149247082122732339731489040093203538003"),
    MontFp!("18659064438372393353457370747065721566775155472245042344407955868575391398227"),
    MontFp!("5472445169355797120102532594663577666122959114916427168191861811468858074106"),
    MontFp!("5736479396434922780032372283951145477278382036445466042175566558138471883256"),
    MontFp!("5858789515110678668852043377232242148671859758285553077440913048712671393005"),
    MontFp!("21246850118219168185271063305296897765625723801557621648465181511098599324087"),
    MontFp!("17002028771994085819083266243193047735479135409113050106000436775164524032767"),
    MontFp!("7231768182472399435043025881564504224209261432496944229952754622583808364662"),
    MontFp!("5192268808030021891087833687120571480250168460891704523413828007027660347449"),
    MontFp!("155280954702114990342659519150396317660769358056459281623163139655330987282"),
    MontFp!("14854916581770636117356174734346719398760044656802819336011836513250363625127"),
    MontFp!("7073330133707073981563645252482184883747227209553458148565724603382063211617"),
    MontFp!("11552901727820752326369819019212373356345242664533541604687911439600998410839"),
    MontFp!("16498472777431504524278891804835701329339284579290421362129572560703054170996"),
    MontFp!("15883953021659975413869470549674887654077365487035978995938080924814420110140"),
    MontFp!("5113956060779612400461603910840885069498537406557921445494632725853569933862"),
    MontFp!("483298495042440662806457758598993822323645521930724998030340185852512688482"),
    MontFp!("10766445303365699867923578603687789365176260785192258460651357353957994798413"),
    MontFp!("437537248148967308738038186268486780317911869772134860610291770780728612825"),
    MontFp!("2248782494276897368500704304648118221776721763418194920069745631130526678778"),
    MontFp!("11996519698479781599346851588306525475592901058657703320678817722996010958491"),
    MontFp!("11147552160539373494239912258759015647691636831617224967342405347497459009781"),
    MontFp!("6443511586377262480935509386142550080603334246636603444725645972724380862000"),
    MontFp!("14037652103655573207851287174381210847897524481226943969275143090841511051545"),
    MontFp!("20440551676670159443439058146684553705387752713962575473805171743357501685350"),
    MontFp!("4110645387847918155964560764849821772289567993739173425110187888287888983217"),
    MontFp!("21304008290304363856925285377235719752147460745679334595317413941184653962392"),
    MontFp!("2094595708142654479561972459960973592363225727488388288328595134311730670599"),
    MontFp!("5023699916721674573827590988728769034776092191923320756976746513022114187443"),
    MontFp!("11830579926658284308382641741495236370905180037217764790765374069414716009322"),
    MontFp!("6168682166955409094250313001986194097131941087653863060759398014186470614460"),
    MontFp!("15618449181545899659927693441424807994945984320830488298504382943205840087269"),
    MontFp!("15296755024931009929333891303177031418911997522823489761353688580552571837211"),
    MontFp!("10058366831379913721225338367243704775399533351596813914644424015971550120104"),
];

/// The Poseidon2 parameters for the BN254 curve with a internal state of size t=12.
pub(crate) const POSEIDON2_BN254_T12_PARAMS: Poseidon2Permutation<
    Scalar,
    T,
    D,
    ROUNDS_F,
    ROUNDS_P,
> = Poseidon2Permutation::new(MAT_DIAG_M_1, EXTERNAL_RC, INTERNAL_RC);

/// Applies the Poseidon2 permutation to a 12-element state over `bn254`.
///
/// Returns a new permuted state based on the input.
///
/// # Arguments
/// * `state` - A reference to the input state array (`[ark_bn254::Fr; 12]`).
///
/// # Returns
/// A permuted state as `[ark_bn254::Fr; 12]`.
pub fn permutation(state: &[ark_bn254::Fr; 12]) -> [ark_bn254::Fr; 12] {
    POSEIDON2_BN254_T12_PARAMS.permutation(state)
}

/// Applies the Poseidon2 permutation in place to a 12-element state over `bn254`.
///
/// Mutates the input state array directly.
///
/// # Arguments
/// * `state` - A mutable reference to the state array (`[ark_bn254::Fr; 12]`).
pub fn permutation_in_place(state: &mut [ark_bn254::Fr; 12]) {
    POSEIDON2_BN254_T12_PARAMS.permutation_in_place(state)
}

#[cfg(test)]
mod tests {

    use crate::bn254::{
        t12::POSEIDON2_BN254_T12_PARAMS,
        test::{TESTRUNS, poseidon2_consistent_perm, poseidon2_kat},
    };
    use std::str::FromStr;

    #[test]
    fn poseidon2_bn254_t12_consistent_perm() {
        for _ in 0..TESTRUNS {
            poseidon2_consistent_perm(&POSEIDON2_BN254_T12_PARAMS);
        }
    }

    #[test]
    fn poseidon2_bn254_t12_kat1() {
        // Parameters are compatible with the original Poseidon2 parameter generation script found at:
        // [https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage](https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage)
        let input = std::array::from_fn(|i| ark_bn254::Fr::from(i as u64));
        let expected = [
            ark_bn254::Fr::from_str(
                "21747906029444710619015915752138298720154944671203754489949869861753578346008",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "21513939049501079563576935737155721457540823975552714210005077333811928299954",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "20878374758297529903859235955630169324042890083998477622604596085833701396575",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "13305407019214443087878969363157154486205891028167855104279647302453885090170",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "16682997524380753461053737193932628645715072618825598039805329428502517736729",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "11014586020348730912470390146630484158055437849128185322266607138671384948760",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "2994526630703474400464067497664388590264808865382597731255193635407418251755",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "18211926869629584578138817320090692365663938300773975413887207856257516040147",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "6849612996087489069533591576260064469744251636332619304205225628198348842052",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "968962401542471672838330254238837400778821690766303842855005474297047085971",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "14385329809671587788248037486076267578972545577910278482783910245125370012450",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "4080137159225732886879922458777678533435313239919796733917069554543642876459",
            )
            .unwrap(),
        ];

        poseidon2_kat(&POSEIDON2_BN254_T12_PARAMS, &input, &expected);
    }
}
