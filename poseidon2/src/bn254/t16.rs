//! Poseidon2 implementation for `t=16`.
//!
//! Parameters are compatible with the original Poseidon2 parameter generation script found at:
//! [https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage](https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage)
use ark_ff::MontFp;

use crate::perm::Poseidon2Permutation;

type Scalar = ark_bn254::Fr;

const T: usize = 16;
const D: u64 = 5;
const ROUNDS_F: usize = 8;
const ROUNDS_P: usize = 57;

const MAT_DIAG_M_1: [Scalar; T] = [
    MontFp!("17461193844262917474612567088085379324070839178292191635138288935422708377828"),
    MontFp!("21859865839500437219873506368375028700019600636763215072666856541906543517155"),
    MontFp!("657423723627838280600552843980047801156792992383720162490137927443885612996"),
    MontFp!("4383574857146254102944849053572243602318130259364473141054769892928366288559"),
    MontFp!("4060049738818362047267783133421285283396394283272641255248048461899364096816"),
    MontFp!("1097522376332776657450197550510817164732149730578229950883722357676902861797"),
    MontFp!("2859229055172632682779984022983091764498366668197988082143656875803883174523"),
    MontFp!("6074908483484229588775486085061773117385672130594504743359451546141727507067"),
    MontFp!("18246815599891931580701642317181269473420563854970570877487418890330745668930"),
    MontFp!("4361519230209174448715665673623724346451293723330354062489882224134574460356"),
    MontFp!("3023550544580252745597147163280021880863917472236114869344697370782369208653"),
    MontFp!("7031107306850044034395147926836834636674631926419901252619137352194764647125"),
    MontFp!("18682189254209480818449101675484477296377256404388988267200354353114555926298"),
    MontFp!("2607823530498270271018957347914030000709287811524557189468801560580746567737"),
    MontFp!("17548321789729059645626426125399684237518653561749684204351298200880324597729"),
    MontFp!("12496388740790921252273145551080917351839384075472621179672177841761393688014"),
];
const EXTERNAL_RC: [[Scalar; T]; ROUNDS_F] = [
    // First external
    [
        MontFp!("7987508670305577132467175719839098676114873458512853854612810620998666595583"),
        MontFp!("2789787787788692092835830565661406728726297908279586884556390502260801752643"),
        MontFp!("2923085958268023927518067610501534000679804083365451744377158124878282576025"),
        MontFp!("4136897588693623681614261973792194839081753316827752013355333397406268139780"),
        MontFp!("13481757729937031981267616300485677282763428226259483639104644219055114857610"),
        MontFp!("4549712975212827362836681120412415081147952438701098901238795063645041765827"),
        MontFp!("19323176998751969108905402456091598168231652031407617505638005194731985531809"),
        MontFp!("6406539181147875582313956743397651288040059510190563896011413357029541481331"),
        MontFp!("15243734910010515309988343061534882675085318947037100669003270565128119155410"),
        MontFp!("6388136752421810075373716462240882592495422546329348514548788721980652241190"),
        MontFp!("15011693089484106333908735231458665842898768850629770618083591692823296397418"),
        MontFp!("11573961130835252474134142707558401302450719556440598834241929878272009168922"),
        MontFp!("19407328810644338405687201905285041369722438092537480512342756077136358932018"),
        MontFp!("21430969851023225465341423232454445521443493598561439390118567123649599289990"),
        MontFp!("17193706251743551030683388818560678852389994042303420464797006277508144868714"),
        MontFp!("3791389208205509792081160535750038379805378554116913395600290273440345828801"),
    ],
    [
        MontFp!("4443674022116082358924119737152423343543828046835293367105977299369313051402"),
        MontFp!("20556007757692803339827754697137127496495384580976799643773337453486500345582"),
        MontFp!("21732614309896215525770849543758552311770742754064665928678206230967824841788"),
        MontFp!("2350394113400461715410541165020187676490904100545319432739327347084889078879"),
        MontFp!("19775936974090295685601178438242036004295778610224530197438576921136701664389"),
        MontFp!("1725376439060272492390615929908985193366172570313768162872577650731402232757"),
        MontFp!("12255515761389684964195750005688015602250339153684484138116108547484432798851"),
        MontFp!("3510498058011570022390323631394973426748397464109728409897284676359435249321"),
        MontFp!("17416184599740753939934645848798651978876453145155036284211391780977918367579"),
        MontFp!("17590806640629642315191745876646662541138768460798306415762298545806324501600"),
        MontFp!("9126984626176303392851410234353741886438699847036393256153057857512200197211"),
        MontFp!("7816717136399410148891198230719597376774716829530786579057127695430583454655"),
        MontFp!("9356587658664432900999201095599992383032248997575871565753557852426605440413"),
        MontFp!("3613118892154837104061140735743996391126463221572779017302631598167534538587"),
        MontFp!("15312641583002364503616465240500469768167116409579865529609815461858872106607"),
        MontFp!("20895281281030313702072042074060167627684590415649329700200364234420653948223"),
    ],
    [
        MontFp!("5137463410503668412705556578968301760708802365793381795577596837508895587974"),
        MontFp!("2992783576564647231225506926232193550692501617041554226743522120885841387288"),
        MontFp!("14720088594609875079595433704692718753566732357332013457611025775312394181948"),
        MontFp!("8768144036608441921566501796338809165738698892354098807810091005871730975052"),
        MontFp!("7532991134485300087254721801054399089197214400547286818586737795748985756136"),
        MontFp!("3792901996819634685401178811381934330083161130574204908308391729693370429116"),
        MontFp!("15935101110199908700215275768883255043945244840238297847431023548570202816588"),
        MontFp!("19393642961767592426452532568396502989981014395147778872221390448675609171346"),
        MontFp!("155918949363761233353288426181480562951420403007714564609379470458362418360"),
        MontFp!("8542612983080903416798197308326653235584238440638486502402108452663527109386"),
        MontFp!("3102078100956228176110489205020115250719306552636033822543101833673231973361"),
        MontFp!("10997874161021911675594999155670135314002657381856718081615532885981471075751"),
        MontFp!("5625265727695002995728469200863087634322980325285271879057120517352284218721"),
        MontFp!("1868598188897437704195089876316298344255918248761606779366147769224503638354"),
        MontFp!("20559221099104651466845775367092516774981735754372572904406935920494116000577"),
        MontFp!("18244597479912127451043989744623814361014933779254004993799631541123080589434"),
    ],
    [
        MontFp!("18198648546362166439166930003556212265878411671611964855634217505426135463642"),
        MontFp!("10356043958022108717942589723822419638579802025381703267680794514671539448413"),
        MontFp!("13462076557842678595809262539855912349193288208056721394689145675513594475608"),
        MontFp!("11384754856824723950667845324670478860096509933183112521740195554878825089822"),
        MontFp!("11846199089561237014635000209735309930768341499968217281358420792832604390328"),
        MontFp!("14756810345512093457111979243567081369178730838502550598767324114642318412028"),
        MontFp!("1165595406641358948440089116770331694759228710449216719254551181578852444634"),
        MontFp!("20666835367900319417421572973401937187766999145362063796299481474822091896839"),
        MontFp!("12990061010481109646624139476687927621447917816835360909851944807656553760572"),
        MontFp!("1783116977987781742463841851758577081073383877973038317820752019796562465302"),
        MontFp!("8903940416606150176329049763389212458551439722921621550960793657396018455541"),
        MontFp!("7818691246611756097003750504136679795785695725892097643498661262459955136804"),
        MontFp!("4882277172763670736261863083249473517190733364755948887880727165161561106826"),
        MontFp!("9546021855862660306521063506063099579472876630386444749970743211912624609092"),
        MontFp!("16884909448813178978130991149821810809300452856451925597438640784766121620580"),
        MontFp!("4432065177462568548089478599231774157969827260421894502967549624495636336960"),
    ],
    // Second external
    [
        MontFp!("12798061852051494731939934571056882910112265953823605836237980041467007152856"),
        MontFp!("14568325302050461741224170340184626483064917163410283367151830334318738249201"),
        MontFp!("18276062790992197117520915640515497669875613512696035253614217546304637470021"),
        MontFp!("20627460470815095235503561768532491088598154093806046061909949003725526571895"),
        MontFp!("17245950571819753931533619001387650713165686747650814547134947309815298664483"),
        MontFp!("11121556865844987632385224735371919379477576593206665792475389674170961534877"),
        MontFp!("6245885212826865991432068547352935466370043397897885095862800217284554071424"),
        MontFp!("14690855571967674705428311747416120698942846798420160396535112558027620183765"),
        MontFp!("3235658783487238943593310349286355309113259814475596134348995210642028885643"),
        MontFp!("20722254815730848854390862523298553268850029431838546301249799038348379700017"),
        MontFp!("19642126089816196888361263588060661717723867255464321287022646144931390112284"),
        MontFp!("8632072582309787677666221011033250027767655916164228152099011508045264115628"),
        MontFp!("20043123735240162399387095494523656672619946732753439734143341922855067252668"),
        MontFp!("11904583185911751509579710797281908145324957152597916871831617558146963369684"),
        MontFp!("15425351929938470853193718127538286221363322147987668566416155015352849606487"),
        MontFp!("7836679868165107790270453843508581901599186549445113382492611620451382004534"),
    ],
    [
        MontFp!("1400391591069146396388357308515920509261560123691496238504102856344666720158"),
        MontFp!("14174858927021982333120256612552461500485120312339832053819158083211342214554"),
        MontFp!("13932623367767696127644734712237196216797254927711341121444975790316174808543"),
        MontFp!("1347625721745170599764025031547760372037468905693488526890308844799397223599"),
        MontFp!("13405042718806919655454735399476138028224524636798057373290706002745159243492"),
        MontFp!("13968798170414332138515357483205257457669805199389971029738637173834063240471"),
        MontFp!("12880063112097200900343214738680204426539712096784765965633204714598974269900"),
        MontFp!("1616907144150909322713379091213954152554304275469379126099951880593629465997"),
        MontFp!("1304127795518325161691119438734502813585937787665151293717948276546158364899"),
        MontFp!("10519101650579155624089241867464558732964322746696440671816554398639492010283"),
        MontFp!("18828931459860199852717606888127153117321647594659992043075338883583443168532"),
        MontFp!("2295869962934928531712533108809705584068393247061194775379130284834010646602"),
        MontFp!("18150621187628277200476269779210788234711835351945125900538777078435916482876"),
        MontFp!("14640835937562336386952719851409386401381343241582808213350078068859999364972"),
        MontFp!("13897434461692657913682776955410351669769404536338213932873325060903666618850"),
        MontFp!("20597831106970808887041371297726673787653852732760233683240573303573794622220"),
    ],
    [
        MontFp!("19778398643313208036144870697848233932488866547046796230853339000492658038515"),
        MontFp!("6490771814639427939657087738362748430177047945561649728963763165932343827645"),
        MontFp!("13006668608365365308391148447358562118183380975503495332476244695621883627943"),
        MontFp!("2376633666069824802975429113636416861869648772191341321978213585368459504946"),
        MontFp!("14026179117201516492847190067273767138692835223271547388459123109718263661737"),
        MontFp!("1558342329810575234249139477022599561470462181488370537976139917078553051256"),
        MontFp!("14134266516506569479923030844790504067461899926138690452282393042351639752970"),
        MontFp!("14210241073253042293952413798925100594617964338995262636477200830442017966589"),
        MontFp!("5307668150181429262219430832958965963829724801921042007172170952001831974281"),
        MontFp!("21453805279253231447711595651829748575193474578778441511169986554818617878108"),
        MontFp!("7651996536678626418407600708073875790655905425227927821193265453381907815315"),
        MontFp!("6847056380992888470717155300697277311257577629811318780799101203119050536885"),
        MontFp!("8070339622120719424098411455163926684249724389012164888625727422216270815130"),
        MontFp!("7205797075464323398573529291457145214072527328852424058232457289443035067442"),
        MontFp!("4536189390770865756295851679323920555154397086063070003221280725313014220755"),
        MontFp!("12868369594844424189974419334382583438474381206841382987726155167536734592505"),
    ],
    [
        MontFp!("11048642748974047225921811671756048438211802032845752026884537530907616453545"),
        MontFp!("8512354908309061211733136180112768331784856936839249322262003771206917210899"),
        MontFp!("9990797211482285791722506260638436977981204610385607689787591992921347349469"),
        MontFp!("16917295660967180721362182776927486975161088518245147837387780258581634757297"),
        MontFp!("9242678265077512551509868219912023157072368469592679399436785051623163092186"),
        MontFp!("19374685276756598833312230288044544032925343679560847095932969931707155093482"),
        MontFp!("21622567804515952265338511322387034516709116685689329667963362810804675904423"),
        MontFp!("20635613322803017955230070354434498414231167117592436903959515733915710373994"),
        MontFp!("12671162889020898856553715587109211682953311928918906931363397665130293702147"),
        MontFp!("10831969496148798054134508249403502812489111994043367592193394348094618993154"),
        MontFp!("11503512535039965163110471823710585207078679112424225764668901657520881406982"),
        MontFp!("7510826680649704378408809285203616429460164251112831558949560497309441632406"),
        MontFp!("9293593444621128830576184699951613976294160517788216200952332436763107636092"),
        MontFp!("4589945008036274623436145388285284315086203451631952327982396273524682595904"),
        MontFp!("16498543997546758928033844742180268058074271522298520395130043287308153701670"),
        MontFp!("7832487555493762303358544193348956815233686901841649713063698970403681802113"),
    ],
];
const INTERNAL_RC: [Scalar; ROUNDS_P] = [
    MontFp!("6815126499856609672222254042135780832357912225575034785912608291432260232898"),
    MontFp!("19646638830255621667048617952591606101396134625966867452105978140921616739655"),
    MontFp!("11302138239612418360180855820394166113153931161226392355253979303164992468696"),
    MontFp!("8902180098716288109045797508667606993836580272659627608764644610681706696552"),
    MontFp!("15024248372289072696331123537928635082008690205771322614522410218457671669030"),
    MontFp!("9108466869828573129651669104555335894770021048312797648102016083513498189708"),
    MontFp!("5593581617985601126480748728563223791129944024411661362725580196781911695155"),
    MontFp!("17431191399111931959268470356880027957220257813539474017925853546766139947893"),
    MontFp!("20056694111825808624858160513735077869168456469163075458067235173482415291365"),
    MontFp!("12425741074116631847070073667050652108769825328521477531880334996410762798746"),
    MontFp!("8955408976800781140561678077373743838002095630499168236895969637952385171003"),
    MontFp!("16662900256793530901152466262552794342547681785570027585388969103311394050068"),
    MontFp!("15534164228080370012679725691771388077179275625252514968160336771975181843179"),
    MontFp!("9363965140782610052578675294485873070433012080344413495407814264639339184892"),
    MontFp!("19323319623697285883311426120970144662636352560337139024696211699935323462843"),
    MontFp!("19667520618631568063264954914272864405753811574830113293225984150020916441476"),
    MontFp!("15782940336500567106839930973880972342821561605750106087667365073898555788045"),
    MontFp!("5160923045939029364513911716806710141262457627449653152435264456021279783023"),
    MontFp!("10043139883103967293969307566861487191986860139967140695758533322158789704934"),
    MontFp!("9993445169513036925291543630609937171163102986151833918628389141526688082060"),
    MontFp!("6582884302334998268745699301765552962157195564283098789965526726552616923981"),
    MontFp!("8305041229363478171256261139992283753297590760909273490788620715914389211529"),
    MontFp!("7079796897596439072858593128409359911268318613394891418800636910413207278585"),
    MontFp!("20678635817698043899626321797240587099874320926950451316190641720259265816441"),
    MontFp!("14894753067584981454975694161439288445040723553115504042795053427766005842897"),
    MontFp!("16460106341643514138189486974101781739866313417094020885985622623293974674192"),
    MontFp!("11239237884257511514154110959163936194004449833910018125975354050164196118126"),
    MontFp!("3123641689295544333004782541102957732852154140928731747113401366319710400061"),
    MontFp!("16451488751543818933205167779631131791174557117152667491386061673610076525602"),
    MontFp!("15931468796949795021075512772761791067340694123789545949980516951699751528241"),
    MontFp!("1066577891854656847806919264940037580194504112770946710163536535894158923970"),
    MontFp!("15595202527205548564243068207186579625413834115497641737606549613925017303248"),
    MontFp!("3644290738195458277775191003855366932943208997370146040039121556214152130509"),
    MontFp!("18314413067954647895689599701967816867934254241849175305689696351121800065506"),
    MontFp!("5879380050156536162954242728743382119442317829662395623582267425305171763846"),
    MontFp!("15881728806833779669142923432009047220075586328068810300670424799337668770015"),
    MontFp!("112867594202583638301419177992010799843740675324183999356030947780085784843"),
    MontFp!("8803331613264154400592631625538219536471149451207752597135044894573888781430"),
    MontFp!("11738836600183962573940017458875930177485668909144396985192921089029743853920"),
    MontFp!("19513172302020035623140909201016474298886363379992337073395143009330447744476"),
    MontFp!("28068217483705394910315625084026354256424731655830382177919239861876103676"),
    MontFp!("17947924735718282282337271927131035663057758605166870825867480796443981188745"),
    MontFp!("9682873619339968299771516390700909696215007477689106778005010864103430988188"),
    MontFp!("14934049656087985335393986301360927724481032122405901654656994092735611149786"),
    MontFp!("450929916328870735102789275352399099901601504938095618223402639964680612624"),
    MontFp!("8440163230602863997243958203195728474722920060951188580301844847673586095325"),
    MontFp!("1930288126134614873378707816837667742844508187465616914161544215337647022335"),
    MontFp!("15268141562824701150734622447786145131756742795495381280691829367288304516432"),
    MontFp!("16942655511827247804632190687377518819617097881981535231389546091106308464233"),
    MontFp!("4051392020423020121600324415237789574761059434547630352009196511936590214670"),
    MontFp!("2583368247209608786367878957201317579599589557403714213419916875979008228180"),
    MontFp!("2307366759343760238637553141164822296713858712864630022457473707021014682968"),
    MontFp!("9628658505673033321937661675733619665817623960523368974782019509550325833346"),
    MontFp!("2758257045058883328030628060582738490658948885480260653173014055397346274669"),
    MontFp!("19105642330203703383081851860313150499920727669364908317985743236889987904091"),
    MontFp!("2183122284249808311901286975903268266793628005635232283478272435841378141616"),
    MontFp!("3723240487756852394377887331009098934500152744315121084282842578293413534502"),
];

/// The Poseidon2 parameters for the BN254 curve with a internal state of size t=16.
pub(crate) const POSEIDON2_BN254_T16_PARAMS: Poseidon2Permutation<
    Scalar,
    T,
    D,
    ROUNDS_F,
    ROUNDS_P,
> = Poseidon2Permutation::new(MAT_DIAG_M_1, EXTERNAL_RC, INTERNAL_RC);

/// Applies the Poseidon2 permutation to a 16-element state over `bn254`.
///
/// Returns a new permuted state based on the input.
///
/// # Arguments
/// * `state` - A reference to the input state array (`[ark_bn254::Fr; 16]`).
///
/// # Returns
/// A permuted state as `[ark_bn254::Fr; 16]`.
pub fn permutation(state: &[ark_bn254::Fr; 16]) -> [ark_bn254::Fr; 16] {
    POSEIDON2_BN254_T16_PARAMS.permutation(state)
}

/// Applies the Poseidon2 permutation in place to a 16-element state over `bn254`.
///
/// Mutates the input state array directly.
///
/// # Arguments
/// * `state` - A mutable reference to the state array (`[ark_bn254::Fr; 16]`).
pub fn permutation_in_place(state: &mut [ark_bn254::Fr; 16]) {
    POSEIDON2_BN254_T16_PARAMS.permutation_in_place(state)
}

#[cfg(test)]
mod tests {

    use crate::bn254::{
        t16::POSEIDON2_BN254_T16_PARAMS,
        test::{TESTRUNS, poseidon2_consistent_perm, poseidon2_kat},
    };
    use std::str::FromStr;
    #[test]
    fn poseidon2_bn254_t16_consistent_perm() {
        for _ in 0..TESTRUNS {
            poseidon2_consistent_perm(&POSEIDON2_BN254_T16_PARAMS);
        }
    }
    #[test]
    fn poseidon2_bn254_t16_kat1() {
        // Parameters are compatible with the original Poseidon2 parameter generation script found at:
        // [https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage](https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage)
        let input = std::array::from_fn(|i| ark_bn254::Fr::from(i as u64));
        let expected = [
            ark_bn254::Fr::from_str(
                "7129053404014098913941583447102076532611276040718594073862066403012892177215",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "5458683216916715697310099658604278457911373519210593239261146303695981710820",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "11764907654416682971926471140388165312909351793032868507449176373009888376893",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "17363012907147515824232626923071954964539976031233523938322583063167173991942",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "16754602647566413012759386310550362661092317428428132757066277153406453157400",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "10442131742273378767812305849732860137449534508695657144865044457198204305243",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "13315916208806700309353847107954103794241355430909228633658159683794835480566",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "14675611827802190925530581036356245293764500457751312643178429199155385431971",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "3800671750689110886099899395588427301982955036566905831860793275457528754896",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "863058427093450397617252284543198432424871511785791089866952153042503171268",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "16110421480974327191214802248220528120081914075253666769021797524181818259452",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "3050248777345249982082587219460801555485024010345812479213241978893548171998",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "8005144369031495385854140476761376792991595443174132540148616210767138457404",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "193712991007063517677674367979478243863141973963118958643316643360558925992",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "6765341258738133397733055933640609905610288576122407133007925535267189590216",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "6411743912316957490668095751870764077217660758836562678571866082387292213586",
            )
            .unwrap(),
        ];

        poseidon2_kat(&POSEIDON2_BN254_T16_PARAMS, &input, &expected);
    }
}
