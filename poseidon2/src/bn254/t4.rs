//! Poseidon2 implementation for `t=4`.
//!
//! Parameters are compatible with the original Poseidon2 parameter generation script found at:
//! [https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage](https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage)
use crate::perm::Poseidon2Permutation;
use ark_ff::MontFp;

type Scalar = ark_bn254::Fr;

const T: usize = 4;
const D: u64 = 5;
const ROUNDS_F: usize = 8;
const ROUNDS_P: usize = 56;

const MAT_DIAG_M_1: [Scalar; T] = [
    MontFp!("7626475329478847982857743246276194948757851985510858890691733676098590062311"),
    MontFp!("5498568565063849786384470689962419967523752476452646391422913716315471115275"),
    MontFp!("148936322117705719734052984176402258788283488576388928671173547788498414613"),
    MontFp!("15456385653678559339152734484033356164266089951521103188900320352052358038155"),
];
const EXTERNAL_RC: [[Scalar; T]; ROUNDS_F] = [
    // First external
    [
        MontFp!("11633431549750490989983886834189948010834808234699737327785600195936805266405"),
        MontFp!("17353750182810071758476407404624088842693631054828301270920107619055744005334"),
        MontFp!("11575173631114898451293296430061690731976535592475236587664058405912382527658"),
        MontFp!("9724643380371653925020965751082872123058642683375812487991079305063678725624"),
    ],
    [
        MontFp!("20936725237749945635418633443468987188819556232926135747685274666391889856770"),
        MontFp!("6427758822462294912934022562310355233516927282963039741999349770315205779230"),
        MontFp!("16782979953202249973699352594809882974187694538612412531558950864304931387798"),
        MontFp!("8979171037234948998646722737761679613767384188475887657669871981433930833742"),
    ],
    [
        MontFp!("5428827536651017352121626533783677797977876323745420084354839999137145767736"),
        MontFp!("507241738797493565802569310165979445570507129759637903167193063764556368390"),
        MontFp!("6711578168107599474498163409443059675558516582274824463959700553865920673097"),
        MontFp!("2197359304646916921018958991647650011119043556688567376178243393652789311643"),
    ],
    [
        MontFp!("4634703622846121403803831560584049007806112989824652272428991253572845447400"),
        MontFp!("17008376818199175111793852447685303011746023680921106348278379453039148937791"),
        MontFp!("18430784755956196942937899353653692286521408688385681805132578732731487278753"),
        MontFp!("4573768376486344895797915946239137669624900197544620153250805961657870918727"),
    ],
    // Second external
    [
        MontFp!("10670120969725161535937685539136065944959698664551200616467222887025111751992"),
        MontFp!("4731853626374224678749618809759140702342195350742653173378450474772131006181"),
        MontFp!("14473527495914528513885847341981310373531349450901830749157165104135412062812"),
        MontFp!("16937191362061486658876740597821783333355021670608822932942683228741190786143"),
    ],
    [
        MontFp!("5656559696428674390125424316117443507583679061659043998559560535270557939546"),
        MontFp!("8897648276515725841133578021896617755369443750194849587616503841335248902806"),
        MontFp!("14938684446722672719637788054570691068799510611164812175626676768545923371470"),
        MontFp!("15284149043690546115252102390417391226617211133644099356880071475803043461465"),
    ],
    [
        MontFp!("2623479025068612775740107497276979457946709347831661908218182874823658838107"),
        MontFp!("6809791961761836061129379546794905411734858375517368211894790874813684813988"),
        MontFp!("2417620338751920563196799065781703780495622795713803712576790485412779971775"),
        MontFp!("4445143310792944321746901285176579692343442786777464604312772017806735512661"),
    ],
    [
        MontFp!("1429019233589939118995503267516676481141938536269008901607126781291273208629"),
        MontFp!("19874283200702583165110559932895904979843482162236139561356679724680604144459"),
        MontFp!("13426632171723830006915194799390005513190035492503509233177687891041405113055"),
        MontFp!("10582332261829184460912611488470654685922576576939233092337240630493625631748"),
    ],
];
const INTERNAL_RC: [Scalar; ROUNDS_P] = [
    MontFp!("5624865188680173294191042415227598609140934495743721047183803859030618890703"),
    MontFp!("8228252753786907198149068514193371173033070694924002912950645971088002709521"),
    MontFp!("17586714789554691446538331362711502394998837215506284064347036653995353304693"),
    MontFp!("12985198716830497423350597750558817467658937953000235442251074063454897365701"),
    MontFp!("13480076116139680784838493959937969792577589073830107110893279354229821035984"),
    MontFp!("480609231761423388761863647137314056373740727639536352979673303078459561332"),
    MontFp!("19503345496799249258956440299354839375920540225688429628121751361906635419276"),
    MontFp!("16837818502122887883669221005435922946567532037624537243846974433811447595173"),
    MontFp!("5492108497278641078569490709794391352213168666744080628008171695469579703581"),
    MontFp!("11365311159988448419785032079155356000691294261495515880484003277443744617083"),
    MontFp!("13876891705632851072613751905778242936713392247975808888614530203269491723653"),
    MontFp!("10660388389107698747692475159023710744797290186015856503629656779989214850043"),
    MontFp!("18876318870401623474401728758498150977988613254023317877612912724282285739292"),
    MontFp!("15543349138237018307536452195922365893694804703361435879256942490123776892424"),
    MontFp!("2839988449157209999638903652853828318645773519300826410959678570041742458201"),
    MontFp!("7566039810305694135184226097163626060317478635973510706368412858136696413063"),
    MontFp!("6344830340705033582410486810600848473125256338903726340728639711688240744220"),
    MontFp!("12475357769019880256619207099578191648078162511547701737481203260317463892731"),
    MontFp!("13337401254840718303633782478677852514218549070508887338718446132574012311307"),
    MontFp!("21161869193849404954234950798647336336709035097706159414187214758702055364571"),
    MontFp!("20671052961616073313397254362345395594858011165315285344464242404604146448678"),
    MontFp!("2772189387845778213446441819361180378678387127454165972767013098872140927416"),
    MontFp!("3339032002224218054945450150550795352855387702520990006196627537441898997147"),
    MontFp!("14919705931281848425960108279746818433850049439186607267862213649460469542157"),
    MontFp!("17056699976793486403099510941807022658662936611123286147276760381688934087770"),
    MontFp!("16144580075268719403964467603213740327573316872987042261854346306108421013323"),
    MontFp!("15582343953927413680541644067712456296539774919658221087452235772880573393376"),
    MontFp!("17528510080741946423534916423363640132610906812668323263058626230135522155749"),
    MontFp!("3190600034239022251529646836642735752388641846393941612827022280601486805721"),
    MontFp!("8463814172152682468446984305780323150741498069701538916468821815030498611418"),
    MontFp!("16533435971270903741871235576178437313873873358463959658178441562520661055273"),
    MontFp!("11845696835505436397913764735273748291716405946246049903478361223369666046634"),
    MontFp!("18391057370973634202531308463652130631065370546571735004701144829951670507215"),
    MontFp!("262537877325812689820791215463881982531707709719292538608229687240243203710"),
    MontFp!("2187234489894387585309965540987639130975753519805550941279098789852422770021"),
    MontFp!("19189656350920455659006418422409390013967064310525314160026356916172976152967"),
    MontFp!("15839474183930359560478122372067744245080413846070743460407578046890458719219"),
    MontFp!("1805019124769763805045852541831585930225376844141668951787801647576910524592"),
    MontFp!("323592203814803486950280155834638828455175703393817797003361354810251742052"),
    MontFp!("9780393509796825017346015868945480913627956475147371732521398519483580624282"),
    MontFp!("14009429785059642386335012561867511048847749030947687313594053997432177705759"),
    MontFp!("13749550162460745037234826077137388777330401847577727796245150843898019635981"),
    MontFp!("19497187499283431845443758879472819384797584633472792651343926414232528405311"),
    MontFp!("3708428802547661961864524194762556064568867603968214870300574294082023305587"),
    MontFp!("1339414413482882567499652761996854155383863472782829777976929310155400981782"),
    MontFp!("6396261245879814100794661157306877072718690153118140891315137894471052482309"),
    MontFp!("2069661495404347929962833138824526893650803079024564477269192079629046031674"),
    MontFp!("15793521554502133342917616035884588152451122589545915605459159078589855944361"),
    MontFp!("17053424498357819626596285492499512504457128907932827007302385782133229252374"),
    MontFp!("13658536470391360399708067455536748955260723760813498481671323619545320978896"),
    MontFp!("21546095668130239633971575351786704948662094117932406102037724221634677838565"),
    MontFp!("21411726238386979516934941789127061362496195649331822900487557574597304399109"),
    MontFp!("1944776378988765673004063363506638781964264107780425928778257145151172817981"),
    MontFp!("15590719714223718537172639598316570285163081746016049278954513732528516468773"),
    MontFp!("1351266421179051765004709939353170430290500926943038391678843253157009556309"),
    MontFp!("6772476224477167317130064764757502335545080109882028900432703947986275397548"),
];

/// The Poseidon2 parameters for the BN254 curve with a internal state of size t=4.
pub(crate) const POSEIDON2_BN254_T4_PARAMS: Poseidon2Permutation<Scalar, T, D, ROUNDS_F, ROUNDS_P> =
    Poseidon2Permutation::new(MAT_DIAG_M_1, EXTERNAL_RC, INTERNAL_RC);

/// Applies the Poseidon2 permutation to a 4-element state over `bn254`.
///
/// Returns a new permuted state based on the input.
///
/// # Arguments
/// * `state` - A reference to the input state array (`[ark_bn254::Fr; 4]`).
///
/// # Returns
/// A permuted state as `[ark_bn254::Fr; 4]`.
pub fn permutation(state: &[ark_bn254::Fr; 4]) -> [ark_bn254::Fr; 4] {
    POSEIDON2_BN254_T4_PARAMS.permutation(state)
}

/// Applies the Poseidon2 permutation in place to a 4-element state over `bn254`.
///
/// Mutates the input state array directly.
///
/// # Arguments
/// * `state` - A mutable reference to the state array (`[ark_bn254::Fr; 4]`).
pub fn permutation_in_place(state: &mut [ark_bn254::Fr; 4]) {
    POSEIDON2_BN254_T4_PARAMS.permutation_in_place(state)
}

#[cfg(test)]
mod tests {

    use crate::bn254::{
        t4::POSEIDON2_BN254_T4_PARAMS,
        test::{TESTRUNS, poseidon2_consistent_perm, poseidon2_kat},
    };
    use std::str::FromStr;

    #[test]
    fn poseidon2_bn254_t4_consistent_perm() {
        for _ in 0..TESTRUNS {
            poseidon2_consistent_perm(&POSEIDON2_BN254_T4_PARAMS);
        }
    }

    #[test]
    fn poseidon2_bn254_t4_kat1() {
        // Parameters are compatible with the original Poseidon2 parameter generation script found at:
        // [https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage](https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage)
        let input = [
            ark_bn254::Fr::from(0u64),
            ark_bn254::Fr::from(1u64),
            ark_bn254::Fr::from(2u64),
            ark_bn254::Fr::from(3u64),
        ];
        let expected = [
            ark_bn254::Fr::from_str(
                "786823568102245344938517132468097745676732687098822989626730198331658606391",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "16105493617470833344375945651585194737369509580406730765188791202038211593826",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "2169165722086073256768101917994796590773204847633762971322389403847680713675",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "20837792685223053096472825292260687493226094382304778455120670180090619921530",
            )
            .unwrap(),
        ];

        poseidon2_kat(&POSEIDON2_BN254_T4_PARAMS, &input, &expected);
    }

    #[test]
    fn poseidon2_bn254_t4_kat2() {
        // Parameters are compatible with the original Poseidon2 parameter generation script found at:
        // [https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage](https://github.com/HorizenLabs/poseidon2/blob/main/poseidon2_rust_params.sage)
        let input = [
            ark_bn254::Fr::from_str(
                "69883186645750645681994932030385246708157590398620226325678277467989879383945",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "69883186645750645681994932030385246708157590398620226325678277467989879383945",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "69883186645750645681994932030385246708157590398620226325678277467989879383945",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "69883186645750645681994932030385246708157590398620226325678277467989879383945",
            )
            .unwrap(),
        ];
        let expected = [
            ark_bn254::Fr::from_str(
                "19876884339830114960362368309895990346608408251258324603720941116757387714453",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "5431247209421262354231150208254604337955649394486434112818062632325221806111",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "687894710690940102848643567468393776669463870896767752431820942566056771027",
            )
            .unwrap(),
            ark_bn254::Fr::from_str(
                "5764589378402668418492845603546890649188307247798553598873913830282103946561",
            )
            .unwrap(),
        ];

        poseidon2_kat(&POSEIDON2_BN254_T4_PARAMS, &input, &expected);
    }
}
